"""
M√≥dulo para p√°gina de configura√ß√µes.

Este m√≥dulo cont√©m a classe Settings respons√°vel por gerenciar
as configura√ß√µes do sistema e prefer√™ncias do usu√°rio.
"""

import streamlit as st
import os
from typing import Dict, Any


class Settings:
    """
    Classe respons√°vel pela p√°gina de configura√ß√µes.
    
    Esta classe gerencia as configura√ß√µes do sistema,
    incluindo temas, prefer√™ncias e configura√ß√µes avan√ßadas.
    """

    def __init__(self):
        """Inicializa a p√°gina de configura√ß√µes."""
        pass

    def render_page(self) -> None:
        """Renderiza a p√°gina de configura√ß√µes."""
        st.markdown("""
            <div class="custom-header fade-in">
                <h1>‚öôÔ∏è Configura√ß√µes</h1>
                <p style="margin: 8px 0 0 0; font-size: 16px; opacity: 0.9;">
                    Gerencie suas prefer√™ncias e configura√ß√µes do sistema
                </p>
            </div>
        """, unsafe_allow_html=True)

        st.divider()
        
        # User Preferences
        self._render_user_preferences()
        
        st.divider()
        
        # System Information
        self._render_system_info()
        
        st.divider()
        
        # Advanced Settings
        self._render_advanced_settings()


    def _render_user_preferences(self) -> None:
        """Renderiza a se√ß√£o de prefer√™ncias do usu√°rio."""
        st.markdown("### üë§ Prefer√™ncias do Usu√°rio")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("**Configura√ß√µes de Exibi√ß√£o:**")
            
            # Auto-refresh option
            auto_refresh = st.checkbox(
                "Auto-atualizar dados",
                value=st.session_state.get('auto_refresh', True),
                help="Atualiza automaticamente os dados ao navegar entre p√°ginas",
                key="auto_refresh_setting"
            )
            st.session_state.auto_refresh = auto_refresh
            
            # Items per page
            items_per_page = st.slider(
                "Itens por p√°gina",
                min_value=6,
                max_value=30,
                value=st.session_state.get('items_per_page', 12),
                step=3,
                help="N√∫mero de posts exibidos por p√°gina na visualiza√ß√£o",
                key="items_per_page_setting"
            )
            st.session_state.items_per_page = items_per_page
            
        with col2:
            st.markdown("**Configura√ß√µes de Notifica√ß√£o:**")
            
            # Success notifications
            show_success = st.checkbox(
                "Exibir notifica√ß√µes de sucesso",
                value=st.session_state.get('show_success_notifications', True),
                help="Mostra mensagens de confirma√ß√£o para a√ß√µes bem-sucedidas",
                key="success_notifications_setting"
            )
            st.session_state.show_success_notifications = show_success
            
            # Error notifications
            show_errors = st.checkbox(
                "Exibir notifica√ß√µes de erro",
                value=st.session_state.get('show_error_notifications', True),
                help="Mostra mensagens de erro detalhadas",
                key="error_notifications_setting"
            )
            st.session_state.show_error_notifications = show_errors

    def _render_system_info(self) -> None:
        """Renderiza informa√ß√µes do sistema."""
        st.markdown("### üìä Informa√ß√µes do Sistema")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("**Vers√£o da Aplica√ß√£o:**")
            st.markdown("""
                <div style="background: var(--input-dark); 
                           color: var(--secondary-blue); 
                           border: 1px solid var(--border-dark); 
                           padding: 8px 12px; 
                           border-radius: 6px; 
                           font-weight: 600; 
                           text-align: center; 
                           font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;">
                    v1.0.0
                </div>
            """, unsafe_allow_html=True)
            
            st.markdown("**Status dos Servi√ßos:**")
            st.markdown("""
                - üü¢ **API Django**: Online
                - üü¢ **Redis Cache**: Conectado
                - üü¢ **Streamlit**: Executando
            """)
            
        with col2:
            st.markdown("**Estat√≠sticas de Sess√£o:**")
            session_keys = len(st.session_state.keys())
            st.metric("Vari√°veis de Sess√£o", session_keys)
            
            st.markdown("**Cache:**")
            cache_status = "Ativo" if "cached_texts" in st.session_state else "Limpo"
            
            # Custom styled cache status
            cache_color = "var(--success-green)" if cache_status == "Ativo" else "var(--border-dark)"
            st.markdown(f"""
                <div style="background: var(--card-dark); 
                           border: 1px solid {cache_color}; 
                           border-radius: 8px; 
                           padding: 16px; 
                           text-align: center;
                           margin: 8px 0;">
                    <div style="color: var(--text-muted); font-size: 14px; margin-bottom: 4px;">Status do Cache</div>
                    <div style="color: var(--text-light); font-size: 24px; font-weight: 600;">{cache_status}</div>
                </div>
            """, unsafe_allow_html=True)
            
            if st.button("üóëÔ∏è Limpar Cache", use_container_width=True, type="secondary"):
                keys_to_remove = [k for k in st.session_state.keys() if k.startswith('cached_')]
                for key in keys_to_remove:
                    del st.session_state[key]
                st.success("Cache limpo com sucesso!")
                st.rerun()

    def _render_advanced_settings(self) -> None:
        """Renderiza configura√ß√µes avan√ßadas."""
        st.markdown("### üîß Configura√ß√µes Avan√ßadas")
        
        with st.expander("‚ö†Ô∏è Configura√ß√µes Avan√ßadas", expanded=False):
            st.markdown("""
                <div style="background: var(--warning-yellow); 
                           color: var(--darker-navy); 
                           padding: 12px; 
                           border-radius: 8px; 
                           border: 1px solid var(--border-dark);
                           margin: 8px 0;">
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Estas configura√ß√µes s√£o para usu√°rios avan√ßados. Altera√ß√µes incorretas podem afetar o funcionamento do sistema.
                </div>
            """, unsafe_allow_html=True)
            
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("**Debug Mode:**")
                debug_mode = st.checkbox(
                    "Ativar modo debug",
                    value=st.session_state.get('debug_mode', False),
                    help="Exibe informa√ß√µes detalhadas de debug",
                    key="debug_mode_setting"
                )
                st.session_state.debug_mode = debug_mode
                
                st.markdown("**API Timeout:**")
                api_timeout = st.number_input(
                    "Timeout da API (segundos)",
                    min_value=5,
                    max_value=60,
                    value=st.session_state.get('api_timeout', 10),
                    help="Tempo limite para requisi√ß√µes da API",
                    key="api_timeout_setting"
                )
                st.session_state.api_timeout = api_timeout
                
            with col2:
                st.markdown("**A√ß√µes de Sistema:**")
                
                if st.button("üîÑ Reiniciar Sess√£o", use_container_width=True, type="secondary"):
                    # Clear all session state except auth
                    keys_to_keep = ['authenticated', 'user_token', 'username']
                    keys_to_remove = [k for k in st.session_state.keys() if k not in keys_to_keep]
                    for key in keys_to_remove:
                        del st.session_state[key]
                    st.success("Sess√£o reiniciada!")
                    st.rerun()
                
                if st.button("üìã Exportar Configura√ß√µes", use_container_width=True, type="secondary"):
                    config_data = {
                        'auto_refresh': st.session_state.get('auto_refresh', True),
                        'items_per_page': st.session_state.get('items_per_page', 12),
                        'debug_mode': st.session_state.get('debug_mode', False),
                        'api_timeout': st.session_state.get('api_timeout', 10)
                    }
                    st.json(config_data)
                    st.info("Configura√ß√µes exportadas. Voc√™ pode copiar estes dados para backup.")

